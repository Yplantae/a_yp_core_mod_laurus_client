// app/build.gradle

plugins {
    id "com.android.application"
    // START: FlutterFire Configuration
    id 'com.google.gms.google-services'
    id 'com.google.firebase.crashlytics'
    // END: FlutterFire Configuration
    id "kotlin-android"
    // The Flutter Gradle Plugin must be applied after the Android and Kotlin Gradle plugins.
    id "dev.flutter.flutter-gradle-plugin"
}

// --------------------
// ğŸ” Keystore ì„¤ì • ë¡œë“œ (ë¡œì»¬ fallbackìš©)
// --------------------
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file("key.properties")
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    namespace = "com.yplantae.core.mod.laurus.a_yp_core_mod_laurus_client"
    compileSdk = 36
    ndkVersion "27.0.12077973"

    defaultConfig {
        applicationId = "com.yplantae.core.mod.laurus.a_yp_core_mod_laurus_client"
        minSdkVersion 24
        targetSdkVersion 36
        versionCode = flutter.versionCode
        versionName = flutter.versionName
        multiDexEnabled true
    }

    // --------------------------------------------
    // ğŸ”’ Signing Configs â€” CI(GHA) + Local fallback
    // --------------------------------------------
    signingConfigs {
        signingConfigs {
            debug {
                // ë°©ê¸ˆ ë§Œë“  íŒŒì¼ì´ android/app/debug.jks ì— ìˆìœ¼ë¯€ë¡œ ë°”ë¡œ íŒŒì¼ëª…ë§Œ ì ìŠµë‹ˆë‹¤.
                storeFile file('../debug.jks')
                storePassword 'Dkagh!2'
                keyAlias 'yp_core_main_client_jks_key_alias'
                keyPassword 'Dkagh!2'
            }
        }
        release {
            // ìš°ì„ ìˆœìœ„ 1: CI ëŸ¬ë„ˆì˜ ~/.gradle/gradle.properties (phase2_install_android_keystore.sh)
            def props = new Properties()
            def gradlePropFile = new File(System.properties['user.home'] + "/.gradle/gradle.properties")
            boolean applied = false

            if (gradlePropFile.canRead()) {
                props.load(new FileInputStream(gradlePropFile))

                def hasAllCiKeys =
                        props['RELEASE_STORE_FILE'] &&
                                props['RELEASE_STORE_PASSWORD'] &&
                                props['RELEASE_KEY_ALIAS'] &&
                                props['RELEASE_KEY_PASSWORD']

                if (hasAllCiKeys) {
                    storeFile file(props['RELEASE_STORE_FILE'])
                    storePassword props['RELEASE_STORE_PASSWORD']
                    keyAlias props['RELEASE_KEY_ALIAS']
                    keyPassword props['RELEASE_KEY_PASSWORD']
                    println "[signing] Using CI-installed keystore at ${props['RELEASE_STORE_FILE']}"
                    applied = true
                } else {
                    println "[warn] gradle.properties exists but some signing keys are missing. Will try local key.properties fallback."
                }
            }

            // ìš°ì„ ìˆœìœ„ 2: ë¡œì»¬ ê°œë°œì fallback (key.properties)
            if (!applied && keystorePropertiesFile.exists()) {
                def hasAllLocalKeys =
                        keystoreProperties['storeFile'] &&
                                keystoreProperties['storePassword'] &&
                                keystoreProperties['keyAlias'] &&
                                keystoreProperties['keyPassword']

                if (hasAllLocalKeys) {
                    def storeFilePath = keystoreProperties['storeFile'] ?: "keystore.jks"
                    storeFile rootProject.file(storeFilePath)
                    storePassword keystoreProperties['storePassword']
                    keyAlias keystoreProperties['keyAlias']
                    keyPassword keystoreProperties['keyPassword']
                    println "[signing] Using local developer keystore (key.properties: ${storeFilePath})"
                    applied = true
                } else {
                    println "[warn] key.properties exists but some signing keys are missing."
                }
            }

            // ìš°ì„ ìˆœìœ„ 3: ì–´ë–¤ ì„¤ì •ë„ ì ìš©ë˜ì§€ ì•ŠìŒ
            if (!applied) {
                println "[warn] No keystore configuration applied â€” release signing will fail unless provided by another mechanism."
            }
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
            shrinkResources true
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'),
                    'proguard-rules.pro'

            ndk {
                // í•„ìš”ì‹œ SYMBOL_TABLE ë˜ëŠ” NONE ì¤‘ ì„ íƒ (í˜„ì¬ëŠ” Flutter ìª½ ì‹¬ë³¼ ìŠ¤í‚µ)
                // debugSymbolLevel 'SYMBOL_TABLE'
                // debugSymbolLevel 'NONE'
            }

            bundle {
                language { enableSplit = false }
                density  { enableSplit = false }
                abi      { enableSplit = true  }
            }
        }
    }

    // Java ë° Kotlin ë²„ì „ì„ 17ë¡œ í†µì¼í•˜ì—¬ ë²„ì „ ë¶ˆì¼ì¹˜ ì˜¤ë¥˜ë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    compileOptions {
        coreLibraryDesugaringEnabled true
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }

    // [ì œê±°ë¨] ë¦´ë¦¬ì¦ˆ ì‹œ ì‚°ì¶œë¬¼ëª… ê³ ì • ë¸”ë¡
    // applicationVariants.all { ... }
}

flutter {
    source = "../.."
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"

    // Firebase BOM ë° êµ¬ì„±
    implementation platform('com.google.firebase:firebase-bom:33.7.0')
    implementation 'com.google.firebase:firebase-analytics'
    implementation 'com.google.firebase:firebase-messaging:24.1.0'

    // ë©€í‹°ë±ìŠ¤ ë° í…ŒìŠ¤íŒ…
    implementation 'androidx.multidex:multidex:2.0.1'
    androidTestImplementation 'androidx.test:runner:1.6.2'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.6.1'

    // Java 8+ ê¸°ëŠ¥ ì‚¬ìš© ì§€ì›
    coreLibraryDesugaring 'com.android.tools:desugar_jdk_libs:2.1.4'

    // SplitInstallManager ê´€ë ¨
    implementation 'com.google.android.play:core-common:2.0.3'
}

// Flutter ë¹Œë“œ ì‹œìŠ¤í…œì—ì„œ ì‹¬ë³¼ ìŠ¤íŠ¸ë¦¬í•‘ì„ ê±´ë„ˆë›°ë„ë¡ ëª…ì‹œí•©ë‹ˆë‹¤.
project.ext.flutterBundleSkipsNativeSymbolTable = true

// Flutter í”„ë¡œì íŠ¸ ë£¨íŠ¸(= android ìƒìœ„ ë””ë ‰í„°ë¦¬)ë¥¼ ì•ˆì „í•˜ê²Œ ê³„ì‚°
def flutterRoot = rootDir.parentFile

// ======================================================================
// AAB/APKê°€ Flutter Toolì—ì„œ ì¸ì‹ë˜ë„ë¡ ìˆ˜ë™ ë³µì‚¬ íƒœìŠ¤í¬ (í•„ìˆ˜)
// ======================================================================

// ---- ê²½ë¡œ ì •ì˜ ----
def flutterApkOut = layout.projectDirectory.dir(
        flutterRoot.toPath().resolve("build/app/outputs/flutter-apk").toString()
)
def flutterAabOut = layout.projectDirectory.dir(
        flutterRoot.toPath().resolve("build/app/outputs/bundle/release").toString()
)
def androidReleaseApkSrc = layout.buildDirectory.dir("outputs/apk/release")
def androidDebugApkSrc   = layout.buildDirectory.dir("outputs/apk/debug")
def androidReleaseAabSrc = layout.buildDirectory.dir("outputs/bundle/release")

// ---- Release AAB ë³µì‚¬ìš© ----
tasks.register("copyReleaseBundleForFlutter", Copy) {
    from(androidReleaseAabSrc)
    include("*.aab")
    into(flutterAabOut)
    rename { "app-release.aab" } // Flutter toolì´ ì°¾ëŠ” í‘œì¤€ ì´ë¦„
}

// ---- Release APK ë³µì‚¬ìš© ----
// (flutter build apk --split-per-abi ìš©)
tasks.register("copyReleaseApkForFlutter", Copy) {
    from(androidReleaseApkSrc)
    include("*.apk")
    into(flutterApkOut)
    // ì´ë¦„ ë³€ê²½(rename) ì•ˆí•¨: app-armeabi-v7a-release.apk ë“± ì›ë³¸ëª… ìœ ì§€
}

// ---- Debug APK ë³µì‚¬ìš© ----
tasks.register("copyDebugApkForFlutter", Copy) {
    from(androidDebugApkSrc)
    include("*.apk")
    into(flutterApkOut)
    rename { "app-debug.apk" } // Flutter toolì´ ì°¾ëŠ” í‘œì¤€ ì´ë¦„
}

// ---- ì‘ì—… ì—°ê²° (release AAB/APK + debug APK ëª¨ë‘ ë³´ì¥) ----
afterEvaluate {
    // AAB: ë¦´ë¦¬ì¦ˆ ë²ˆë“¤ë§ í›„ .aab ë³µì‚¬
    tasks.matching { it.name in ["signReleaseBundle", "packageReleaseBundle", "bundleRelease"] }.configureEach {
        finalizedBy(tasks.named("copyReleaseBundleForFlutter"))
    }

    // APK (Release): ë¦´ë¦¬ì¦ˆ íŒ¨í‚¤ì§•/ì¡°ë¦½ í›„ .apk ë³µì‚¬
    tasks.matching { it.name in ["packageRelease", "assembleRelease"] }.configureEach {
        finalizedBy(tasks.named("copyReleaseApkForFlutter"))
    }

    // APK (Debug): ë””ë²„ê·¸ íŒ¨í‚¤ì§•/ì¡°ë¦½ í›„ .apk ë³µì‚¬
    tasks.matching { it.name in ["packageDebug", "assembleDebug"] }.configureEach {
        finalizedBy(tasks.named("copyDebugApkForFlutter"))
    }
}
